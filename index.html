<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Budget Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f9f9fb;
            color: #333;
            margin: 0;
            padding: 0;
        }

        header {
            background-color: #4a90e2;
            color: white;
            padding: 20px;
            text-align: center;
        }

        main {
            max-width: 900px;
            margin: auto;
            padding: 20px;
        }

        form, .summary-box, ul {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
        }

        h2 {
            color: #4a90e2;
            border-bottom: 2px solid #eee;
            padding-bottom: 5px;
        }

        input, select {
            width: 100%;
            padding: 10px;
            margin-top: 8px;
            margin-bottom: 16px;
            border-radius: 6px;
            border: 1px solid #ccc;
        }

        button {
            padding: 10px 20px;
            background-color: #4a90e2;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .charts {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: space-between;
        }

        canvas {
            background: white;
            padding: 10px;
            border-radius: 10px;
        }
    </style>
</head>
<body>
<header>
    <h1>Budget Tracker</h1>
</header>
<main>

    {% with messages = get_flashed_messages() %}
        {% if messages %}
            <ul>
                {% for message in messages %}
                    <li>{{ message }}</li>
                {% endfor %}
            </ul>
        {% endif %}
    {% endwith %}

    <form method="get" action="{{ url_for('index') }}">
        <label for="month">Filter by Month:</label>
        <input type="month" id="month" name="month" value="{{ selected_month }}">
        <button type="submit">Apply</button>
    </form>

    <div class="summary-box">
        <strong>Total Income:</strong> ${{ total_income }} |
        <strong>Total Expenses:</strong> ${{ total_expense }} |
        <strong>Balance:</strong> ${{ balance }}
    </div>

    <form action="{{ url_for('add_transaction') }}" method="POST">
        <label>Transaction Type</label>
        <select name="transaction_type" id="transaction_type" required>
            <option value="">Select</option>
            <option value="Income">Income</option>
            <option value="Expense">Expense</option>
        </select>

        <label>Amount</label>
        <input type="number" step="0.01" name="amount" required>

        <div id="category-section" style="display:none;">
            <label>Category</label>
            <select name="category" id="category">
                <option value="">Select</option>
                <option value="Groceries">Groceries</option>
                <option value="Transportation">Transportation</option>
                <option value="Healthcare">Healthcare</option>
                <option value="Childcare">Childcare</option>
                <option value="Utilities">Utilities</option>
                <option value="Rent/Mortgage">Rent/Mortgage</option>
                <option value="Clothing">Clothing</option>
                <option value="Debt Payment">Debt Payment</option>
                <option value="Subscriptions">Subscriptions</option>
                <option value="Savings">Savings</option>
                <option value="Entertainment">Entertainment</option>
                <option value="Food">Food</option>
                <option value="Bills">Bills</option>
                <option value="Other">Other</option>
            </select>

            <div id="custom-category" style="display:none;">
                <label>Custom Category</label>
                <input type="text" name="custom_category">
            </div>
        </div>

        <button type="submit">Add Transaction</button>
    </form>

    <h2>Transactions</h2>
    <ul>
        {% for tx in transactions %}
            <li>{{ tx.date.strftime('%Y-%m-%d') }} - {{ tx.transaction_type }}: ${{ tx.amount }}{% if tx.transaction_type == 'Expense' %} ({{ tx.category }}){% endif %}</li>
        {% endfor %}
    </ul>

    <h2>Visual Summary</h2>
    <div class="charts">
        <canvas id="expensePieChart" width="300" height="300"></canvas>
        <canvas id="barChart" width="300" height="300"></canvas>
    </div>
</main>

<script>
    const typeSelect = document.getElementById('transaction_type');
    const categorySection = document.getElementById('category-section');
    const categorySelect = document.getElementById('category');
    const customCategory = document.getElementById('custom-category');

    function toggleCategoryVisibility() {
        if (typeSelect.value === 'Expense') {
            categorySection.style.display = 'block';
        } else {
            categorySection.style.display = 'none';
            customCategory.style.display = 'none';
        }
    }

    function toggleCustomCategory() {
        if (categorySelect.value === 'Other') {
            customCategory.style.display = 'block';
        } else {
            customCategory.style.display = 'none';
        }
    }

    typeSelect.addEventListener('change', toggleCategoryVisibility);
    categorySelect.addEventListener('change', toggleCustomCategory);

    window.addEventListener('DOMContentLoaded', () => {
        toggleCategoryVisibility();
        toggleCustomCategory();
    });

    const expenseData = {{ expense_by_category | tojson }};
    if (Object.keys(expenseData).length > 0) {
        new Chart(document.getElementById('expensePieChart'), {
            type: 'pie',
            data: {
                labels: Object.keys(expenseData),
                datasets: [{
                    data: Object.values(expenseData),
                    backgroundColor: [
                        '#ff6384', '#36a2eb', '#ffce56', '#2ecc71', '#e67e22',
                        '#9b59b6', '#3498db', '#f1c40f', '#95a5a6', '#1abc9c'
                    ]
                }]
            }
        });
    }

    new Chart(document.getElementById('barChart'), {
        type: 'bar',
        data: {
            labels: ['Income', 'Expenses'],
            datasets: [{
                label: 'Amount',
                data: [{{ total_income }}, {{ total_expense }}],
                backgroundColor: ['#2ecc71', '#e74c3c']
            }]
        }
    });
</script>
</body>
</html>
